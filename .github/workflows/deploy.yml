name: Deploy en VM Privada - TermÃ³metro PolÃ­tico

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted  # <--- Esto busca tu runner en la VM
    
    steps:
      # 1. El runner descarga el cÃ³digo nuevo del repo
      - name: Tomar cÃ³digo mÃ¡s reciente
        uses: actions/checkout@v4

      # 2. Copiar archivos a la carpeta de producciÃ³n
      - name: Desplegar archivos
        run: |
          echo "ğŸš€ Iniciando despliegue en /mnt/tesis_data/codigo/sentiment_elections_prd..."
          
          # Limpiar carpeta PRD completamente (excepto .env si existe)
          echo "ğŸ§¹ Limpiando carpeta de destino..."
          if [ -d /mnt/tesis_data/codigo/sentiment_elections_prd ]; then
            # Guardar .env si existe (contiene secretos)
            if [ -f /mnt/tesis_data/codigo/sentiment_elections_prd/.env ]; then
              cp /mnt/tesis_data/codigo/sentiment_elections_prd/.env /tmp/.env.backup
            fi
            
            # Eliminar todo en PRD
            rm -rf /mnt/tesis_data/codigo/sentiment_elections_prd/*
            rm -rf /mnt/tesis_data/codigo/sentiment_elections_prd/.github
            rm -rf /mnt/tesis_data/codigo/sentiment_elections_prd/.git
            
            # Restaurar .env si lo guardamos
            if [ -f /tmp/.env.backup ]; then
              cp /tmp/.env.backup /mnt/tesis_data/codigo/sentiment_elections_prd/.env
              rm /tmp/.env.backup
            fi
          else
            mkdir -p /mnt/tesis_data/codigo/sentiment_elections_prd
          fi
          
          # Copiar archivos de DEV a PRD (espejo exacto, sin .git ni .github)
          echo "ğŸ“¦ Copiando archivos desde DEV a PRD..."
          rsync -av --exclude='.git' --exclude='.github' --exclude='.env' ./ /mnt/tesis_data/codigo/sentiment_elections_prd/
          
          echo "âœ… Archivos copiados exitosamente (carpeta reemplazada)."

      # 3. Build & Deploy con docker-compose (desde shared_infrastructure)
      - name: Build & Deploy Docker
        env:
          # Leer secretos de GitHub y pasarlos como variables de entorno
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
          ORACLE_PASSWORD: ${{ secrets.ORACLE_PASSWORD }}
          ORACLE_CONNECTION_STRING: ${{ secrets.ORACLE_CONNECTION_STRING }}
        run: |
          set -e  # Salir si hay algÃºn error
          
          echo "ğŸ³ Iniciando proceso Docker con Nginx reverse proxy..."
          cd /mnt/tesis_data/codigo/shared_infrastructure
          
          # PASO 0: Respaldar imagen anterior (rollback)
          BACKUP_IMAGE="shared_infrastructure-sentiment-api:backup"
          CURRENT_IMAGE="shared_infrastructure-sentiment-api:latest"
          
          echo "ğŸ’¾ Respaldando imagen anterior..."
          if sudo docker images | grep -q "$CURRENT_IMAGE"; then
            sudo docker tag $CURRENT_IMAGE $BACKUP_IMAGE || true
            echo "âœ… Imagen respaldada como: $BACKUP_IMAGE"
          else
            echo "âš ï¸  Primera vez, no hay imagen anterior para respaldar"
          fi
          
          # Crear archivo .env en shared_infrastructure con los secretos de GitHub
          cat > .env << EOF
          ORACLE_USER=${ORACLE_USER}
          ORACLE_PASSWORD=${ORACLE_PASSWORD}
          ORACLE_CONNECTION_STRING=${ORACLE_CONNECTION_STRING}
          EOF
          
          # PASO 1: Detener solo sentiment-api (Nginx sigue corriendo)
          echo "ğŸ›‘ Deteniendo sentiment-api anterior..."
          sudo docker compose stop sentiment-api || true
          
          # PASO 2: Build de la nueva imagen
          echo "ğŸ”¨ Construyendo nueva imagen..."
          if ! sudo docker compose build --no-cache sentiment-api; then
            echo "âŒ ERROR: Fallo en build de imagen"
            echo "ğŸ”„ Restaurando imagen anterior..."
            sudo docker tag $BACKUP_IMAGE $CURRENT_IMAGE || true
            exit 1
          fi
          echo "âœ… Build exitoso"
          
          # PASO 3: Levantar solo sentiment-api (Nginx ya estÃ¡ corriendo)
          echo "ğŸš€ Iniciando sentiment-api (Nginx continÃºa)..."
          if ! sudo docker compose up -d --no-deps sentiment-api; then
            echo "âŒ ERROR: Fallo al iniciar sentiment-api"
            echo "ğŸ”„ Restaurando imagen anterior..."
            sudo docker tag $BACKUP_IMAGE $CURRENT_IMAGE || true
            # Intentar reiniciar con imagen anterior
            sudo docker compose up -d --no-deps sentiment-api || true
            exit 1
          fi
          echo "âœ… sentiment-api iniciado"
          
          # PASO 4: Validar que sentiment-api estÃ© corriendo (mÃ¡x 40s)
          echo "â³ Validando sentiment-api..."
          HEALTHCHECK_PASSED=false
          for i in {1..40}; do
            # Validar que sentiment-api estÃ© corriendo
            SENTIMENT_STATUS=$(sudo docker compose ps --format json 2>/dev/null | grep sentiment-api | jq -r '.State' 2>/dev/null | head -1 || echo "")
            
            if [ "$SENTIMENT_STATUS" = "running" ]; then
              echo "âœ… sentiment-api corriendo correctamente"
              HEALTHCHECK_PASSED=true
              break
            fi
            echo "â³ Intento $i/40 - Sentiment: $SENTIMENT_STATUS"
            sleep 1
          done
          
          # PASO 5: Si falla, hacer rollback
          if [ "$HEALTHCHECK_PASSED" = false ]; then
            echo "âŒ ERROR: sentiment-api no pasÃ³ validaciÃ³n despuÃ©s de 40 segundos"
            echo "ğŸ”„ Iniciando rollback..."
            
            # Detener la versiÃ³n fallida
            sudo docker compose stop sentiment-api || true
            
            # Restaurar imagen anterior
            sudo docker tag $BACKUP_IMAGE $CURRENT_IMAGE || true
            
            # Reintentar con imagen anterior
            echo "ğŸ“¦ Levantando sentiment-api con imagen respaldada..."
            if sudo docker compose up -d --no-deps sentiment-api; then
              echo "âœ… Rollback completado - Servicio restaurado"
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âš ï¸  DEPLOY FALLIDO - ROLLBACK COMPLETADO"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "sentiment-api fallÃ³ la validaciÃ³n"
              echo "Se ha restaurado la versiÃ³n anterior"
              echo "Verifica los logs del contenedor:"
              echo "  docker logs sentiment-api"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            else
              echo "âŒ CRÃTICO: Rollback fallÃ³"
              exit 1
            fi
            exit 1
          fi
          
          # PASO 6: Limpiar .env despuÃ©s de deploy (por seguridad)
          rm -f .env
          
          # PASO 7: Limpieza de imÃ¡genes viejas
          echo "ğŸ§¹ Limpiando imÃ¡genes antiguas..."
          sudo docker image prune -f
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOY EXITOSO - sentiment-api"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Nueva versiÃ³n deployada correctamente"
          echo "Nginx reverse proxy continÃºa sin interrupciones"
          echo "sentiment-api corriendo en puerto 8888"
          echo "Accesible en: http://localhost/termometro/"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
